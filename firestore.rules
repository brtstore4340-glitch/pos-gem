rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() 
             && request.auth.token.role in ['admin', 'SM-SGM'];
    }
    
    function isActiveProduct() {
      return resource.data.ProductStatus is string
             && resource.data.ProductStatus.matches('^0');
    }
    
    // Products collection
    match /products/{productId} {
      // Authenticated users can read any product.
      allow read: if isAuthenticated();
      
      // Admins can create, update, and delete products, with validation.
      allow create: if isAdmin()
                    && request.resource.data.sku is string
                    && request.resource.data.sku.size() > 0
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.unitPrice is number
                    && request.resource.data.unitPrice >= 0;

      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Usernames: Publicly readable for lookup, writable only by the user who owns it.
    match /usernames/{uname} {
      allow read: if true;
      allow write: if isAuthenticated() && request.auth.uid == resource.data.uid;
    }
    
    // User profiles: Can only be read or written by the owner.
    match /users/{uid} {
      allow read, write: if isAuthenticated() && request.auth.uid == uid;
    }
    
    // Upload metadata
    match /upload_meta/{uploadId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Admin metadata
    match /adminMeta/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Fallback: deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
